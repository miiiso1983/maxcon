# نظام إدارة الصيدلية متعدد المستأجرين

## 🏗️ نظرة عامة على النظام

تم تطوير نظام إدارة الصيدلية ليكون نظاماً متعدد المستأجرين (Multi-Tenant) مع عزل كامل للبيانات ونظام ترخيص متقدم ولوحة تحكم رئيسية شاملة للسوبر أدمن.

## 🎯 المميزات الرئيسية

### 1. إدارة المستأجرين (Tenant Management)
- ✅ إنشاء وإدارة حسابات المستأجرين
- ✅ عزل كامل للبيانات بين المستأجرين
- ✅ نظام ترخيص متقدم مع تواريخ انتهاء
- ✅ إحصائيات استخدام مفصلة لكل مستأجر
- ✅ نظام تعليق وإلغاء تعليق المستأجرين

### 2. نظام الترخيص (License Management)
- ✅ أنواع تراخيص متعددة (تجريبي، أساسي، احترافي، مؤسسي)
- ✅ تحديد حدود المستخدمين والتخزين لكل ترخيص
- ✅ مميزات قابلة للتخصيص حسب نوع الترخيص
- ✅ نظام تجديد تلقائي ويدوي
- ✅ تتبع انتهاء التراخيص والتنبيهات

### 3. لوحة التحكم الرئيسية (Super Admin Dashboard)
- ✅ إحصائيات شاملة للنظام
- ✅ مراقبة أداء المستأجرين
- ✅ تقارير الإيرادات والاستخدام
- ✅ رسوم بيانية تفاعلية
- ✅ تنبيهات الأمان والنظام

### 4. الأمان والمراقبة (Security & Monitoring)
- ✅ مصادقة ثنائية (2FA) للسوبر أدمن ومديري المستأجرين
- ✅ سياسات كلمة مرور متقدمة
- ✅ مراقبة محاولات تسجيل الدخول المشبوهة
- ✅ سجل تدقيق شامل لجميع العمليات
- ✅ حظر IP تلقائي للأنشطة المشبوهة

### 5. إدارة البيانات (Data Management)
- ✅ حذف آمن للمستأجرين مع جميع بياناتهم
- ✅ نسخ احتياطية تلقائية قبل الحذف
- ✅ استعادة البيانات من النسخ الاحتياطية
- ✅ تصدير البيانات بصيغ متعددة

## 🏛️ هيكل النظام

### النماذج الرئيسية (Models)

#### 1. Tenant (المستأجر)
```php
- id: معرف فريد
- tenant_code: رمز المستأجر
- name: اسم الشركة
- email: البريد الإلكتروني
- license_type: نوع الترخيص
- license_start_date: تاريخ بداية الترخيص
- license_end_date: تاريخ انتهاء الترخيص
- max_users: الحد الأقصى للمستخدمين
- max_storage_gb: الحد الأقصى للتخزين
- features: المميزات المتاحة
- status: حالة المستأجر
```

#### 2. TenantUser (مستخدمو المستأجر)
```php
- id: معرف فريد
- tenant_id: معرف المستأجر
- name: الاسم
- email: البريد الإلكتروني
- role: الدور (system_manager, admin, manager, employee)
- two_factor_enabled: تفعيل المصادقة الثنائية
- status: حالة المستخدم
```

#### 3. SuperAdmin (السوبر أدمن)
```php
- id: معرف فريد
- name: الاسم
- email: البريد الإلكتروني
- role: الدور (super_admin, admin, support)
- permissions: الصلاحيات المخصصة
- can_create_tenants: صلاحية إنشاء مستأجرين
- can_delete_tenants: صلاحية حذف مستأجرين
- two_factor_enabled: تفعيل المصادقة الثنائية
```

#### 4. License (الترخيص)
```php
- id: معرف فريد
- license_type: نوع الترخيص
- name: اسم الترخيص
- max_users: الحد الأقصى للمستخدمين
- max_storage_gb: الحد الأقصى للتخزين
- features: المميزات المتاحة
- price_monthly: السعر الشهري
- price_yearly: السعر السنوي
```

### الخدمات (Services)

#### 1. TenantManager
- إنشاء وإعداد المستأجرين الجدد
- تحديث إحصائيات الاستخدام
- إدارة ترقيات التراخيص
- إنشاء النسخ الاحتياطية

#### 2. TenantDeletionService
- حذف آمن للمستأجرين
- تنظيف جميع البيانات المرتبطة
- إنشاء نسخ احتياطية قبل الحذف
- تقارير الحذف المفصلة

#### 3. TwoFactorAuthService
- إدارة المصادقة الثنائية
- توليد رموز QR
- التحقق من الرموز
- إدارة رموز الاسترداد

#### 4. PasswordPolicyService
- فرض سياسات كلمة المرور
- التحقق من قوة كلمة المرور
- منع إعادة استخدام كلمات المرور
- تتبع انتهاء صلاحية كلمات المرور

#### 5. SecurityMonitoringService
- مراقبة محاولات تسجيل الدخول المشبوهة
- حظر IP التلقائي
- تسجيل الأنشطة الأمنية
- إرسال تنبيهات الأمان

### Middleware

#### 1. SuperAdminAuth
- التحقق من تسجيل دخول السوبر أدمن
- فحص حالة الحساب النشطة

#### 2. SuperAdminPermission
- التحقق من صلاحيات السوبر أدمن
- فرض القيود على العمليات الحساسة

#### 3. TenantScope
- تطبيق نطاق المستأجر على الاستعلامات
- التحقق من صحة الترخيص
- تعيين المستأجر الحالي

#### 4. EnsureTenantDataIsolation
- ضمان عزل البيانات بين المستأجرين
- تسجيل أنشطة المستأجرين
- فرض قيود الوصول

### Traits

#### TenantScoped
- تطبيق نطاق المستأجر تلقائياً على النماذج
- توفير طرق للاستعلام عبر المستأجرين
- إدارة البيانات الخاصة بالمستأجر

## 🚀 التثبيت والإعداد

### 1. تشغيل المايجريشن
```bash
php artisan migrate
```

### 2. تشغيل السيدر
```bash
php artisan db:seed --class=MultiTenantSystemSeeder
```

### 3. إعداد المجلدات
```bash
php artisan storage:link
```

### 4. تحديث الصلاحيات
```bash
chmod -R 755 storage
chmod -R 755 bootstrap/cache
```

## 🔐 بيانات تسجيل الدخول الافتراضية

### السوبر أدمن الرئيسي
- **البريد الإلكتروني:** superadmin@pharmacy-erp.com
- **كلمة المرور:** SuperAdmin@2024
- **الرابط:** `/admin/login`

### الأدمن المساعد
- **البريد الإلكتروني:** admin@pharmacy-erp.com
- **كلمة المرور:** Admin@2024

### فريق الدعم
- **البريد الإلكتروني:** support@pharmacy-erp.com
- **كلمة المرور:** Support@2024

### مديري المستأجرين التجريبيين
- **صيدلية النور:** ahmed@alnoor-pharmacy.com / Manager@2024
- **صيدلية الشفاء:** fatima@alshifa-pharmacy.com / Manager@2024

## 📊 أنواع التراخيص

### 1. النسخة التجريبية (Trial)
- **المدة:** 30 يوم
- **المستخدمين:** 2
- **التخزين:** 1 GB
- **السعر:** مجاني

### 2. الباقة الأساسية (Basic)
- **المستخدمين:** 5
- **التخزين:** 5 GB
- **السعر:** 299 ريال/شهر
- **المميزات:** إدارة المخزون، المبيعات، التقارير الأساسية

### 3. الباقة الاحترافية (Professional)
- **المستخدمين:** 15
- **التخزين:** 20 GB
- **السعر:** 799 ريال/شهر
- **المميزات:** جميع مميزات الأساسية + المشتريات، الوصفات، التقارير المتقدمة

### 4. الباقة المؤسسية (Enterprise)
- **المستخدمين:** 100
- **التخزين:** 100 GB
- **السعر:** 1999 ريال/شهر
- **المميزات:** جميع المميزات + API، تعدد المواقع، التحليلات المتقدمة

## 🛡️ الأمان

### سياسات كلمة المرور
- الحد الأدنى: 8 أحرف
- يجب أن تحتوي على: أحرف كبيرة وصغيرة، أرقام، رموز خاصة
- منع إعادة استخدام آخر 5 كلمات مرور
- انتهاء الصلاحية كل 90 يوم

### المصادقة الثنائية
- دعم Google Authenticator
- رموز استرداد احتياطية
- إجبارية للسوبر أدمن

### مراقبة الأمان
- تسجيل جميع محاولات تسجيل الدخول
- حظر IP تلقائي بعد محاولات فاشلة
- تنبيهات الأنشطة المشبوهة
- سجل تدقيق شامل

## 📈 المراقبة والتقارير

### إحصائيات النظام
- عدد المستأجرين النشطين
- إجمالي الإيرادات
- استخدام التخزين والمستخدمين
- معدلات النمو

### تقارير المستأجرين
- إحصائيات الاستخدام
- تقارير النشاط
- حالة التراخيص
- التنبيهات والإشعارات

### سجلات التدقيق
- جميع عمليات السوبر أدمن
- أنشطة المستأجرين
- تغييرات النظام
- محاولات الأمان

## ⚠️ تنبيهات مهمة

1. **تغيير كلمات المرور الافتراضية** في بيئة الإنتاج
2. **تفعيل المصادقة الثنائية** لجميع حسابات السوبر أدمن
3. **إجراء نسخ احتياطية دورية** لقاعدة البيانات
4. **مراقبة سجلات الأمان** بانتظام
5. **تحديث النظام** بانتظام للحصول على آخر التحديثات الأمنية

## 🔧 الصيانة

### تنظيف البيانات القديمة
```bash
php artisan app:cleanup-audit-logs --days=180
```

### تحديث إحصائيات المستأجرين
```bash
php artisan app:update-tenant-stats
```

### فحص التراخيص المنتهية
```bash
php artisan app:check-expired-licenses
```

## 📞 الدعم الفني

للحصول على الدعم الفني أو الإبلاغ عن مشاكل:
- **البريد الإلكتروني:** support@pharmacy-erp.com
- **الهاتف:** +966501234569

---

**تم تطوير هذا النظام بواسطة فريق تطوير نظام إدارة الصيدلية**
